EXTRA_DIST=\
 setup.py.in \
 MANIFEST.in \
 AUTHORS \
 COPYING \
 otestpoint

BUILT_SOURCES = \
 setup.py \
 otestpoint/iptraffic/iptraffic_pb2.py

all-local:
	$(PYTHON) setup.py build

dist-hook:
	find $(distdir) -name "*_pb2.py" -delete

clean-local: setup.py
	$(PYTHON) setup.py clean
	-rm -rf build
	-rm -rf dist
	-rm -f $(BUILT_SOURCES)
	-find . -name "*.pyc" -delete
	-rm -rf opentestpoint_probe_iptraffic_python.egg-info
	-rm -f 	opentestpoint-probe-iptraffic-python*.tar.gz

DISTCLEANFILES=setup.py

sdist:
	$(PYTHON) setup.py sdist

edit = sed                              \
        -e 's|@VERSION[@]|$(VERSION)|g' \
        -e 's|@PYTHON[@]|$(PYTHON)|g'   \
        -e 's|@DEBIAN_VERSION[@]|$(DEBIAN_VERSION)|g' \
        -e 's|@DATE_RFC2822[@]|$(DATE_RFC2822)|g'

setup.py:	setup.py.in
	if test -f $@; then chmod u+w $@; fi
	$(edit) $< > $@
	chmod g-w,u-w $@

install-exec-hook: $(BUILT_SOURCES)
	$(PYTHON) setup.py install \
    --single-version-externally-managed \
    -O1 \
    --root=$(DESTDIR)

otestpoint/iptraffic/iptraffic_pb2.py: ../iptraffic.proto
	protoc -I=.. -I=$(libotestpoint_PROTODIR) --python_out=otestpoint/iptraffic $<
	sed -i -e 's/import measurementtable_pb2/from otestpoint.interface import measurementtable_pb2/' $@
